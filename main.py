import streamlit as st
import datetime
import random
from datetime import date

# ------------------------ åŸºç¡€æ•°æ®é…ç½® ------------------------

zodiacs = ["é¼ ","ç‰›","è™","å…”","é¾™","è›‡","é©¬","ç¾Š","çŒ´","é¸¡","ç‹—","çŒª"]
tiangans = ["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"]
dizhis = ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"]

# çº³éŸ³äº”è¡Œå¯¹ç…§è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
nayin_map = {
    ("ç”²å­","ä¹™ä¸‘"): ("æµ·ä¸­é‡‘", "é‡‘"), ("ä¸™å¯…","ä¸å¯"): ("ç‚‰ä¸­ç«", "ç«"),
    ("æˆŠè¾°","å·±å·³"): ("å¤§æ—æœ¨", "æœ¨"), ("åºšåˆ","è¾›æœª"): ("è·¯æ—åœŸ", "åœŸ"),
    ("å£¬ç”³","ç™¸é…‰"): ("å‰‘é”‹é‡‘", "é‡‘"), ("ç”²æˆŒ","ä¹™äº¥"): ("å±±å¤´ç«", "ç«"),
    ("ä¸™å­","ä¸ä¸‘"): ("æ¶§ä¸‹æ°´", "æ°´"), ("æˆŠå¯…","å·±å¯"): ("åŸå¤´åœŸ", "åœŸ"),
    ("åºšè¾°","è¾›å·³"): ("ç™½èœ¡é‡‘", "é‡‘"), ("å£¬åˆ","ç™¸æœª"): ("æ¨æŸ³æœ¨", "æœ¨"),
    ("ç”²ç”³","ä¹™é…‰"): ("æ³‰ä¸­æ°´", "æ°´"), ("ä¸™æˆŒ","ä¸äº¥"): ("å±‹ä¸ŠåœŸ", "åœŸ"),
    ("æˆŠå­","å·±ä¸‘"): ("éœ¹é›³ç«", "ç«"), ("åºšå¯…","è¾›å¯"): ("æ¾æŸæœ¨", "æœ¨"),
    ("å£¬è¾°","ç™¸å·³"): ("é•¿æµæ°´", "æ°´"), ("ç”²åˆ","ä¹™æœª"): ("æ²™ä¸­é‡‘", "é‡‘"),
    ("ä¸™ç”³","ä¸é…‰"): ("å±±ä¸‹ç«", "ç«"), ("æˆŠæˆŒ","å·±äº¥"): ("å¹³åœ°æœ¨", "æœ¨"),
    ("åºšå­","è¾›ä¸‘"): ("å£ä¸ŠåœŸ", "åœŸ"), ("å£¬å¯…","ç™¸å¯"): ("é‡‘ç®”é‡‘", "é‡‘"),
    ("ç”²è¾°","ä¹™å·³"): ("è¦†ç¯ç«", "ç«"), ("ä¸™åˆ","ä¸æœª"): ("å¤©æ²³æ°´", "æ°´"),
    ("æˆŠç”³","å·±é…‰"): ("å¤§é©¿åœŸ", "åœŸ"), ("åºšæˆŒ","è¾›äº¥"): ("é’—é’é‡‘", "é‡‘"),
    ("å£¬å­","ç™¸ä¸‘"): ("æ¡‘æŸ˜æœ¨", "æœ¨"), ("ç”²å¯…","ä¹™å¯"): ("å¤§æºªæ°´", "æ°´"),
    ("ä¸™è¾°","ä¸å·³"): ("æ²™ä¸­åœŸ", "åœŸ"), ("æˆŠåˆ","å·±æœª"): ("å¤©ä¸Šç«", "ç«"),
    ("åºšç”³","è¾›é…‰"): ("çŸ³æ¦´æœ¨", "æœ¨"), ("å£¬æˆŒ","ç™¸äº¥"): ("å¤§æµ·æ°´", "æ°´")
}

# ä¸‰ä¸–ä¹¦å©šé…ç­‰çº§
marriage_levels = {
    ("é¼ ","ç‰›"): "ä¸Šä¸Šå©š", ("è™","çŒª"): "ä¸Šç­‰å©š", ("å…”","ç‹—"): "ä¸Šç­‰å©š",
    ("è›‡","çŒ´"): "ä¸­ç­‰å©š", ("é©¬","ç¾Š"): "ä¸­ç­‰å©š", ("é¾™","é¸¡"): "ä¸­ç­‰å©š",
    ("é¼ ","é©¬"): "ä¸‹ç­‰å©š", ("ç‰›","ç¾Š"): "ä¸‹ç­‰å©š", ("è™","çŒ´"): "ä¸‹ç­‰å©š",
    ("å…”","é¸¡"): "ä¸‹ç­‰å©š", ("é¾™","ç‹—"): "ä¸‹ç­‰å©š", ("è›‡","çŒª"): "ä¸‹ç­‰å©š"
}

# ------------------------ æ ¸å¿ƒç®—æ³•æ¨¡å— ------------------------

def get_zodiac(year):
    """è·å–ç”Ÿè‚–"""
    return zodiacs[(year - 4) % 12]

def get_ganzhi(year):
    """è·å–å¹´æŸ±å¤©å¹²åœ°æ”¯"""
    gan_index = (year - 4) % 10
    zhi_index = (year - 4) % 12
    return tiangans[gan_index] + dizhis[zhi_index]

def get_nayin(ganzhi):
    """è·å–çº³éŸ³äº”è¡Œ"""
    for key, value in nayin_map.items():
        if ganzhi in key:
            return value
    return ("", "")

def calculate_marriage_score(z1, z2, w1, w2):
    """ç»¼åˆè¯„åˆ†ç®—æ³•"""
    base_scores = {"å…­åˆ":95, "ä¸‰åˆ":85, "åŠåˆ":75, "æ™®é€š":65, "å…­å®³":55, "å…­å†²":45}
    relation = get_zodiac_relation(z1, z2)["type"]
    score = base_scores.get(relation, 60)
    
    # äº”è¡Œç›¸ç”ŸåŠ æˆ
    if (w1, w2) in shengke_map and shengke_map[(w1, w2)] == "ç›¸ç”Ÿ":
        score += 15
    elif (w2, w1) in shengke_map and shengke_map[(w2, w1)] == "ç›¸ç”Ÿ":
        score += 10
    
    return min(max(score, 0), 100)

# ------------------------ åŠŸèƒ½æ¨¡å— ------------------------

def show_zodiac_analysis(z1, z2):
    """ç”Ÿè‚–å…³ç³»åˆ†æ"""
    rel_info = get_zodiac_relation(z1, z2)
    with st.expander("ğŸ”® ç”Ÿè‚–é…å¯¹åˆ†æ", expanded=True):
        cols = st.columns([1,3])
        cols[0].metric("ç”Ÿè‚–ç»„åˆ", f"{z1} + {z2}")
        cols[1].metric("é…å¯¹ç±»å‹", rel_info["type"])
        st.progress(calculate_marriage_score(z1, z2, "", "")/100)

def show_nayin_analysis(gz1, gz2):
    """çº³éŸ³äº”è¡Œåˆ†æ"""
    ny1, wx1 = get_nayin(gz1)
    ny2, wx2 = get_nayin(gz2)
    
    with st.expander("ğŸŒŒ çº³éŸ³äº”è¡Œåˆ†æ"):
        cols = st.columns(2)
        cols[0].write(f"ç”·æ–¹å¹´å‘½ï¼š{gz1}{ny1}({wx1})")
        cols[1].write(f"å¥³æ–¹å¹´å‘½ï¼š{gz2}{ny2}({wx2})")
        
        # äº”è¡Œç”Ÿå…‹åˆ¤æ–­
        if (wx1, wx2) in shengke_map:
            rel = shengke_map[(wx1, wx2)]
            st.success(f"äº”è¡Œå…³ç³»ï¼š{rel}({wx1}â†’{wx2})")
        else:
            st.info("äº”è¡Œæ— ç›´æ¥ç”Ÿå…‹")

def show_marriage_level(z1, z2):
    """ä¸‰ä¸–ä¹¦å©šé…ç­‰çº§"""
    level = marriage_levels.get((z1,z2), marriage_levels.get((z2,z1), "éœ€åˆå…«å­—"))
    with st.expander("ğŸ“œ ä¸‰ä¸–ä¹¦å©šé…"):
        st.subheader(f"å©šé…ç­‰çº§ï¼š{level}")
        if "ä¸Š" in level:
            st.markdown("> ã€Šä¸‰å‘½é€šä¼šã€‹äº‘ï¼šé˜´é˜³ä¼šåˆï¼Œç´ç‘Ÿå’Œè°")
        elif "ä¸­" in level:
            st.markdown("> ã€Šæ¸Šæµ·å­å¹³ã€‹äº‘ï¼šåˆšæŸ”ç›¸æµï¼Œäº¦ä¸»å‰ç¥¥")
        else:
            st.markdown("> ã€Šæ»´å¤©é«“ã€‹äº‘ï¼šå†²å…‹åˆ‘å®³ï¼Œé¡»å‡­è°ƒè§£")

# ------------------------ ç•Œé¢äº¤äº’ ------------------------

def main():
    st.set_page_config(page_title="å‘¨æ˜“å©šé…ç³»ç»Ÿ", layout="wide")
    st.title("ğŸ å‘¨æ˜“å©šé…é¢„æµ‹ç³»ç»Ÿ")
    
    # ä¾§è¾¹æ æ§åˆ¶
    with st.sidebar:
        st.header("âš™ï¸ å‚æ•°è®¾ç½®")
        analysis_mode = st.radio("åˆ†ææ¨¡å¼", ["æ‰‹åŠ¨è¾“å…¥", "éšæœºæµ‹è¯•"])
        
        if analysis_mode == "æ‰‹åŠ¨è¾“å…¥":
            man_year = st.number_input("ç”·æ–¹å‡ºç”Ÿå¹´", 1900, 2100, 1990)
            woman_year = st.number_input("å¥³æ–¹å‡ºç”Ÿå¹´", 1900, 2100, 1993)
        else:
            man_year = random.randint(1980, 2010)
            woman_year = random.randint(1980, 2010)
            st.write(f"éšæœºæµ‹è¯•å¹´ä»½ï¼šç”·{man_year} / å¥³{woman_year}")
    
    # ä¸»æ˜¾ç¤ºåŒºåŸŸ
    tab1, tab2, tab3 = st.tabs(["æ ¸å¿ƒåˆ†æ", "å‰æ—¥æ¨è", "å­å—£é¢„æµ‹"])
    
    with tab1:
        z1, z2 = get_zodiac(man_year), get_zodiac(woman_year)
        gz1, gz2 = get_ganzhi(man_year), get_ganzhi(woman_year)
        
        show_zodiac_analysis(z1, z2)
        show_nayin_analysis(gz1, gz2)
        show_marriage_level(z1, z2)
        
        # ç»¼åˆè¯„åˆ†
        score = calculate_marriage_score(z1, z2, *[get_nayin(gz1)[1], get_nayin(gz2)[1]])
        st.divider()
        st.subheader(f"ç»¼åˆè¯„åˆ†ï¼š{score}/100")
        st.write("ã€Šå‘½ç†çº¦è¨€ã€‹äº‘ï¼šå¤©åœ°ä¹‹é“ï¼Œè´µåœ¨é˜´é˜³è°ƒå’Œ")
    
    with tab2:
        current_year = datetime.date.today().year
        good_years = [current_year + i for i in range(3) if (current_year + i - man_year) % 12 in [4,8,0]]
        st.markdown(f"""
        ### ğŸ‹ æ¨èå©šæœŸ
        - è¿‘æœŸå‰å¹´ï¼š{', '.join(map(str, good_years))}
        - ä¼˜é€‰æœˆä»½ï¼šåŒæ˜¥å¹´é—°æœˆã€ä¸‰åˆæœˆï¼ˆå‚è€ƒå…·ä½“å¹´ä»½é»„å†ï¼‰
        > ã€Šåçºªè¾¨æ–¹ä¹¦ã€‹äº‘ï¼šå®œé€‰ä¸‰åˆã€å…­åˆä¹‹æ—¥ï¼Œé¿åˆ‘å†²ç ´å®³
        """)
    
    with tab3:
        wx1, wx2 = get_nayin(gz1)[1], get_nayin(gz2)[1]
        st.markdown(f"""
        ### ğŸ‘¶ å­å—£é¢„æµ‹
        - ç”Ÿè‚²æ—¶æœºï¼šå©šå{random.randint(1,3)}å¹´å†…è§å–œ
        - å­å¥³æ•°é‡ï¼šä¸»{random.choice([1,2])}å­©ï¼Œå¯èƒ½æœ‰åŒç”Ÿä¹‹å–œ
        - äº”è¡Œè°ƒå’Œï¼š{"æ—º" if wx1 != wx2 else "å¹³"}
        > ã€Šæ»´å¤©é«“ã€‹äº‘ï¼šæœ¨ç«é€šæ˜ä¸»æ–‡ç§€ï¼Œé‡‘æ°´ç›¸ç”Ÿå¤šä¿Šä¿
        """)

if __name__ == "__main__":
    main()
        st.code(result)

if __name__ == "__main__":
    main()
    
